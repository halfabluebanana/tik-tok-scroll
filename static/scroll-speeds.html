<!DOCTYPE html>
<html>
  <head>
    <title>Scroll Metrics & Motor Controls</title>
    <style>
      body {
        font-family: 'Courier New', monospace;
        margin: 0;
        padding: 20px;
        background: #282828;
        color: white;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .container {
        max-width: 800px;
        width: 100%;
        margin: 0 auto;
      }
      .panel {
        background: rgba(0, 0, 0, 0.8);
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }
      .metric-item {
        display: flex;
        justify-content: space-between;
        padding: 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        transition: background 0.3s;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .metric-item:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .metric-label {
        font-weight: bold;
        color: white;
      }
      .metric-value {
        font-family: 'Courier New', monospace;
        font-size: 1.1em;
        color: white;
      }
      .controls {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-top: 20px;
      }
      .control-button {
        background: transparent;
        color: white;
        border: 1px solid white;
        padding: 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-family: 'Courier New', monospace;
      }
      .control-button:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
      }
      .control-button:active {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(0);
      }
      h2 {
        margin-top: 0;
        color: white;
        text-align: center;
        margin-bottom: 20px;
        font-size: 24px;
        font-family: 'Courier New', monospace;
      }
      #debug-panel {
        margin-top: 20px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      #debug-log {
        height: 100px;
        overflow-y: auto;
        background: rgba(0, 0, 0, 0.5);
        padding: 10px;
        border-radius: 5px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .status {
        margin: 10px 0;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
        font-weight: bold;
        font-family: 'Courier New', monospace;
      }
      .status.connected {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      .status.disconnected {
        background: rgba(255, 0, 0, 0.1);
        color: white;
        border: 1px solid rgba(255, 0, 0, 0.3);
      }
      .connection-panel {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 15px;
        align-items: center;
        margin-bottom: 15px;
      }
      
      .connection-info {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      
      .connection-time {
        font-size: 0.8em;
        color: #888;
      }
      
      .reconnect-button {
        background: transparent;
        color: white;
        border: 1px solid white;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
      }
      
      .reconnect-button:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      
      .transmission-log {
        margin-top: 15px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 5px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .transmission-item {
        margin: 5px 0;
        padding: 5px;
        border-radius: 3px;
        background: rgba(255, 255, 255, 0.05);
      }
      
      .transmission-item.sent {
        border-left: 3px solid #4CAF50;
      }
      
      .transmission-item.received {
        border-left: 3px solid #2196F3;
      }
      
      .transmission-item.error {
        border-left: 3px solid #f44336;
      }

      .transmission-log {
        background: #1a1a1a;
        border-radius: 4px;
        padding: 10px;
        margin-top: 10px;
        max-height: 300px;
        overflow-y: auto;
        font-family: monospace;
      }

      .log-entry {
        display: grid;
        grid-template-columns: 100px 100px 1fr 100px;
        gap: 10px;
        padding: 5px;
        border-bottom: 1px solid #333;
      }

      .log-entry:last-child {
        border-bottom: none;
      }

      .timestamp {
        color: #888;
      }

      .type {
        font-weight: bold;
      }

      .type.command {
        color: #4CAF50;
      }

      .type.response {
        color: #2196F3;
      }

      .type.error {
        color: #f44336;
      }

      .data {
        color: #fff;
        white-space: pre-wrap;
        word-break: break-all;
      }

      .interval {
        color: #FFC107;
        text-align: right;
      }

      .metrics-grid {
        display: grid;
        gap: 10px;
        padding: 10px;
        background: #1a1a1a;
        border-radius: 4px;
      }

      .metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 5px;
        border-bottom: 1px solid #333;
      }

      .metric:last-child {
        border-bottom: none;
      }

      .label {
        color: #888;
        font-weight: bold;
      }

      #connection-status {
        margin: 10px 0;
        padding: 5px;
        background: #1a1a1a;
        border-radius: 4px;
      }

      .reconnect-btn {
        background: #2196F3;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
      }

      .reconnect-btn:hover {
        background: #1976D2;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="panel">
        <h2>Scroll Metrics</h2>
        <div class="metrics" id="metrics">
          <div class="metric-item">
            <span class="metric-label">Current Speed:</span>
            <span class="metric-value" id="current-speed">0 containers/s</span>
          </div>
          <div class="metric-item">
            <span class="metric-label">Average Speed:</span>
            <span class="metric-value" id="average-speed">0 containers/s</span>
          </div>
          <div class="metric-item">
            <span class="metric-label">Direction:</span>
            <span class="metric-value" id="direction">NONE</span>
          </div>
          <div class="metric-item">
            <span class="metric-label">Container:</span>
            <span class="metric-value" id="container">None</span>
          </div>
          <div class="metric-item">
            <span class="metric-label">Time in Container:</span>
            <span class="metric-value" id="time-in-container">0 ms</span>
          </div>
        </div>
      </div>
      
      <div class="panel">
        <h3>Current Scroll Metrics</h3>
        <div class="metrics-grid">
          <div class="metric">
            <span class="label">Scroll Position:</span>
            <span id="scroll-position">0</span>
          </div>
          <div class="metric">
            <span class="label">Direction:</span>
            <span id="scroll-direction">-</span>
          </div>
          <div class="metric">
            <span class="label">Speed:</span>
            <span id="scroll-speed">0</span>
          </div>
          <div class="metric">
            <span class="label">Container Index:</span>
            <span id="container-index">-</span>
          </div>
          <div class="metric">
            <span class="label">Total Containers:</span>
            <span id="total-containers">-</span>
          </div>
        </div>
      </div>

      <div class="panel">
        <h3>Last ESP32 Command</h3>
        <div class="metrics-grid">
          <div class="metric">
            <span class="label">Angle:</span>
            <span id="last-angle">0</span>
          </div>
          <div class="metric">
            <span class="label">Direction:</span>
            <span id="last-direction">-</span>
          </div>
          <div class="metric">
            <span class="label">Speed:</span>
            <span id="last-speed">0</span>
          </div>
          <div class="metric">
            <span class="label">Interval:</span>
            <span id="last-interval">1000</span>ms
          </div>
        </div>
      </div>

      <div class="panel">
        <h3>Motor Controls</h3>
        <div class="control-grid">
          <div class="control-group">
            <label>Speed:</label>
            <input type="range" id="speed-control" min="0" max="100" value="50">
            <span id="speed-value">50</span>
          </div>
          <div class="control-group">
            <label>Direction:</label>
            <select id="direction-control">
              <option value="1">Forward</option>
              <option value="0">Stop</option>
              <option value="-1">Reverse</option>
            </select>
          </div>
          <button onclick="sendMotorCommand()" class="control-btn">Send Command</button>
        </div>
      </div>

      <div class="panel" id="debug-panel">
        <h2>ESP32 Master Connection (Serial)</h2>
        <div class="connection-panel">
          <div class="connection-info">
        <div class="status" id="connection-status">Checking connection...</div>
            <div class="connection-time" id="last-connection-time"></div>
          </div>
          <button class="reconnect-button" onclick="reconnectESP32()">Reconnect</button>
        </div>
        
        <div class="transmission-log">
          <h3>Data Transmission</h3>
          <div id="transmission-log"></div>
        </div>
        
        <div id="debug-log"></div>
      </div>
    </div>

    <script>
      const debugLog = document.getElementById('debug-log');
      const connectionStatus = document.getElementById('connection-status');
      const lastConnectionTime = document.getElementById('last-connection-time');
      const transmissionLog = document.getElementById('transmission-log');
      
      function log(message) {
        const timestamp = new Date().toLocaleTimeString();
        debugLog.innerHTML += `[${timestamp}] ${message}<br>`;
        debugLog.scrollTop = debugLog.scrollHeight;
      }

      function logTransmission(type, data) {
        const timestamp = new Date().toLocaleTimeString();
        const item = document.createElement('div');
        item.className = `transmission-item ${type}`;
        
        let content = '';
        switch(type) {
          case 'frontend':
            content = `ðŸ“± Frontend: ${JSON.stringify(data)}`;
            break;
          case 'server':
            content = `ðŸ–¥ï¸ Server: ${JSON.stringify(data)}`;
            break;
          case 'master':
            content = `ðŸ“¡ ESP32 Master: ${JSON.stringify(data)}`;
            break;
          case 'slave':
            content = `ðŸ“¡ ESP32 Slave: ${JSON.stringify(data)}`;
            break;
          case 'error':
            content = `âŒ Error: ${data}`;
            break;
        }
        
        item.innerHTML = `[${timestamp}] ${content}`;
        transmissionLog.insertBefore(item, transmissionLog.firstChild);
        
        // Keep only last 20 transmissions
        while (transmissionLog.children.length > 20) {
          transmissionLog.removeChild(transmissionLog.lastChild);
        }
      }

      async function reconnectESP32() {
        try {
          log('Attempting to reconnect ESP32...');
          const response = await fetch('/api/reconnect-esp32', { method: 'POST' });
          if (response.ok) {
            log('Reconnection request sent successfully');
          } else {
            log('Failed to send reconnection request');
          }
        } catch (error) {
          log(`Error during reconnection: ${error.message}`);
        }
      }

      // Function to send motor commands
      async function sendCommand(speed, direction) {
        try {
          const command = {
            currentSpeed: speed,
            direction: direction === 1 ? 'down' : 'up',
            scrollPosition: 0,
            totalDistance: 0,
            averageSpeed: 0
          };
          
          logTransmission('frontend', command);
          const response = await fetch('/api/scroll-metrics', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(command),
          });
          
          if (!response.ok) {
            logTransmission('error', 'Failed to send motor command');
            connectionStatus.textContent = 'Disconnected';
            connectionStatus.className = 'status disconnected';
            lastConnectionTime.textContent = `Last attempt: ${new Date().toLocaleTimeString()}`;
          } else {
            const result = await response.json();
            logTransmission('server', result);
            connectionStatus.textContent = 'Connected';
            connectionStatus.className = 'status connected';
            lastConnectionTime.textContent = `Last successful: ${new Date().toLocaleTimeString()}`;
          }
        } catch (error) {
          logTransmission('error', error.message);
          connectionStatus.textContent = 'Disconnected';
          connectionStatus.className = 'status disconnected';
          lastConnectionTime.textContent = `Last error: ${new Date().toLocaleTimeString()}`;
        }
      }

      // Function to update metrics with error handling
      function updateMetrics(metrics) {
        try {
          console.log('Updating metrics:', metrics);
          document.getElementById('current-speed').textContent = 
            Math.round(metrics.currentSpeed || 0) + ' containers/s';
          document.getElementById('average-speed').textContent = 
            Math.round(metrics.averageSpeed || 0) + ' containers/s';
          document.getElementById('direction').textContent = 
            (metrics.direction || 'nothing').toUpperCase();
          document.getElementById('container').textContent = 
            metrics.containerMetrics?.containerIndex >= 0 ? 
            `Container ${metrics.containerMetrics.containerIndex + 1}` : 'None';
          document.getElementById('time-in-container').textContent = 
            Math.round(metrics.containerMetrics?.timeSpentInContainer || 0) + ' ms';
          document.getElementById('scroll-position').textContent = metrics.scrollPosition || 0;
          document.getElementById('scroll-direction').textContent = metrics.direction || '-';
          document.getElementById('scroll-speed').textContent = metrics.currentSpeed || 0;
          document.getElementById('container-index').textContent = metrics.containerIndex || '-';
          document.getElementById('total-containers').textContent = metrics.totalContainers || '-';
          
          // Log the metrics update
          logTransmission('frontend', metrics);
        } catch (error) {
          console.error('Error updating metrics:', error);
          logTransmission('error', 'Error updating metrics: ' + error.message);
        }
      }

      // Poll for metrics updates with better error handling
      setInterval(async () => {
        try {
          log('Fetching metrics...');
          const response = await fetch('/api/scroll-metrics');
          if (response.ok) {
            const metrics = await response.json();
            console.log('Received metrics:', metrics);
            updateMetrics(metrics);
            connectionStatus.textContent = 'Connected';
            connectionStatus.className = 'status connected';
          } else {
            throw new Error('Failed to fetch metrics: ' + response.status);
          }
        } catch (error) {
          console.error('Error fetching metrics:', error);
          log('Error fetching metrics: ' + error.message);
          connectionStatus.textContent = 'Disconnected';
          connectionStatus.className = 'status disconnected';
        }
      }, 100);

      // Initial connection check
      fetch('/api/scroll-metrics')
        .then(response => {
          if (response.ok) {
            connectionStatus.textContent = 'Connected';
            connectionStatus.className = 'status connected';
            log('Initial connection successful');
          } else {
            throw new Error('Failed to connect');
          }
        })
        .catch(error => {
          connectionStatus.textContent = 'Disconnected';
          connectionStatus.className = 'status disconnected';
          log('Initial connection failed: ' + error.message);
        });

      function addTransmissionLog(type, data, interval) {
        const log = document.getElementById('transmission-log');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        
        const timestamp = new Date().toLocaleTimeString();
        const typeSpan = document.createElement('span');
        typeSpan.className = `type ${type.toLowerCase()}`;
        typeSpan.textContent = type;
        
        const dataSpan = document.createElement('span');
        dataSpan.className = 'data';
        dataSpan.textContent = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;
        
        const intervalSpan = document.createElement('span');
        intervalSpan.className = 'interval';
        intervalSpan.textContent = `${interval}ms`;
        
        entry.innerHTML = `
          <span class="timestamp">[${timestamp}]</span>
          ${typeSpan.outerHTML}
          ${dataSpan.outerHTML}
          ${intervalSpan.outerHTML}
        `;
        
        log.insertBefore(entry, log.firstChild);
        
        // Keep only last 50 entries
        while (log.children.length > 50) {
          log.removeChild(log.lastChild);
        }
      }

      // Modify the existing sendData function to include logging
      function sendData(data) {
        updateLastCommand(data);
        fetch('/api/send-data', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
          if (result.error) {
            console.error('Error:', result.error);
          }
        })
        .catch(error => {
          console.error('Error:', error);
        });
      }

      // Add error logging
      function logError(message) {
        addTransmissionLog('Error', message, 0);
      }

      // Modify the existing updateConnectionStatus function
      function updateConnectionStatus(status) {
        const statusElement = document.getElementById('connection-status');
        statusElement.textContent = `Status: ${status}`;
      }

      function updateLastCommand(data) {
        document.getElementById('last-angle').textContent = data.angle || 0;
        document.getElementById('last-direction').textContent = data.direction || '-';
        document.getElementById('last-speed').textContent = data.speed || 0;
        document.getElementById('last-interval').textContent = data.interval || 1000;
      }

      function sendMotorCommand() {
        const speed = document.getElementById('speed-control').value;
        const direction = document.getElementById('direction-control').value;
        sendCommand(speed, direction);
      }
    </script>
  </body>
</html>
